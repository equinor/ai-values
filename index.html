<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VALUES â€“ What are your values?</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  body { padding: 20px; }
  canvas { max-height: 70vh; }
  footer { margin-top: 20px; text-align: center; font-size: 0.9em; color: #666; }
  .modal-lg { max-width: 800px; }
  .answer-buttons .btn { margin: 4px; }
  .toggle-btn.active { background-color: #0d6efd; color: white; }
</style>
</head>
<body>

<div class="container text-center">
  <p class="lead text-muted"><span style="font-weight: 600;">The Ingelhart-Welzel Cultural Map</span> combines data from the <a href="https://www.worldvaluessurvey.org/wvs.jsp">World Values Survey</a> and <a href="https://europeanvaluesstudy.eu/">European Values Study</a>, two long-running investigations into people's values. It simplifies values into two axes: survival (eg personal security) on the left vs self-expression (eg personal independence) on the right, and traditional&ndash;theistic at the bottom vs secular&ndash;rational at the top. Points represent national means for 2005 to 2022.</p>
  <div id="regionToggles" class="btn-group mb-3" role="group" aria-label="Toggle regions"></div>
  <canvas id="valuesChart"></canvas>
  <div class="d-flex justify-content-center gap-2 mt-3">
    <button class="btn btn-lg" id="aiSystemBtn" style="background-color:#ff1243; color:white;">
      Show AI systems
    </button>
    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#questionsModal" id="startQuizBtn">
      Plot yourself!
    </button>
  </div>
</div>

<!-- Questions Modal -->
<div class="modal fade" id="questionsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Answer the questions</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="questionContent"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="prevBtn">Back</button>
        <button class="btn btn-primary" id="nextBtn">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- About Modal -->
<div class="modal fade" id="aboutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">About</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>The Ingelhart-Welzel Cultural Map combines data from the World and European Values Surveys, long-running research projects into the values of human beings. Recently, Tao et al extended the idea to estimating values of large language models, and my own evaluations of various models are also shown. Your answers to the questions place your own values as shown. See the Tao paper for more on the methodology: Tao, Y, O Viberg, RS Baker, RF Kizilcec (2024). Cultural bias and cultural alignment of large language models. PNAS Nexus 3 (9), September 2024, <a href="https://doi.org/10.1093/pnasnexus/pgae346" target="_blank">https://doi.org/10.1093/pnasnexus/pgae346</a>.</p>
      </div>
    </div>
  </div>
</div>

<footer>
  2025 Matt Hall, Equinor | This app stores no data | <a href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">About</a> | <a href="https://github.com/equinor/ai-values">GitHub</a>
</footer>

<script>

// TODO
// - Move the AI systems button down to bottom with YOU button
// - Consider re-adding some removed points (see below)
// - Equal axes -- seems really hard

// CSV DATA
const csvData = `idx,country,region,x,y,remark
8,Albania,African-Islamic,-0.6513683031253179,0.5065700767510233,
12,Algeria,African-Islamic,-0.7582593324896224,-0.5404389949657308,
20,Andorra,Catholic Europe,2.256986281355116,0.6729333845174158,
31,Azerbaijan,African-Islamic,-1.0605637388649314,-0.4393968649117976,
32,Argentina,Latin America,0.6537541425664857,-0.2509776140083846,
36,Australia,English-Speaking,2.5621694050632797,0.0559681558190461,
40,Austria,Catholic Europe,1.2592771590123308,0.2289208281740216,
50,Bangladesh,African-Islamic,-0.5780884973827165,-1.296050821865884,
51,Armenia,Orthodox Europe,-0.8005537018467237,-0.6034719936248698,
56,Belgium,Catholic Europe,1.2585555367876335,0.3171329004096196,
68,Bolivia,Latin America,-0.2713415683678335,-1.0317183627133624,
70,Bosnia Herzegovina,Orthodox Europe,-0.544152614012641,0.296318094953278,
76,Brazil,Latin America,0.0990341455558271,-0.4784620118096129,
100,Bulgaria,Orthodox Europe,-0.4134890740671729,1.355992825127911,
104,Myanmar,West & South Asia,-0.8198832359408768,-0.8030150719520548,
112,Belarus,Orthodox Europe,-0.3279937615826192,0.6783026763722234,
124,Canada,English-Speaking,2.0551962950507106,0.0934349817535171,
152,Chile,Latin America,0.2592380620561673,-0.1548454542064195,
156,China,Confucian,0.1223348402962029,0.7296302507939841,
158,Taiwan ROC,Confucian,-0.0989241675094803,1.3651758852619933,
170,Colombia,Latin America,0.2514591412344316,-1.595763639808513,
191,Croatia,Catholic Europe,0.2296250550971795,0.1340143440144715,
203,Czechia,Catholic Europe,0.9043772710373776,1.2754065276659976,
208,Denmark,Protestant Europe,2.704712164518167,0.6971181648703797,
218,Ecuador,Latin America,-0.0162524589612252,-1.590517851667677,
231,Ethiopia,African-Islamic,-0.7161078725486231,-0.7694142655384919,
246,Finland,Protestant Europe,1.882625107497575,0.6047127396075502,
250,France,Catholic Europe,1.350512225712502,0.514365939845673,
268,Georgia,Orthodox Europe,-1.1516935175928231,-0.4659206345008573,
275,Palestine,African-Islamic,-1.2023337623986583,-0.6281378086843619,
276,Germany,Protestant Europe,1.343040274926089,1.210984586940927,
288,Ghana,African-Islamic,-0.7424744694711967,-1.6323921086185738,
300,Greece,Orthodox Europe,0.287323800806142,0.3463649332889463,
320,Guatemala,Latin America,-0.1016574245224893,-1.4041904213066922,
332,Haiti,Latin America,0.2359425710177818,-0.696748724526003,
344,Hong Kong SAR,Confucian,0.4783712630187762,1.418848952292896,
348,Hungary,Catholic Europe,-0.193313486243026,0.77543158071453,
352,Iceland,Protestant Europe,1.8938655594946077,-0.058117242713395,
356,India,West & South Asia,-0.3455399425743827,-0.4336385279582483,
360,Indonesia,West & South Asia,-0.769024764246198,-0.7726658985855934,
364,Iran,African-Islamic,-0.7633150104981619,-0.3040229322655758,
368,Iraq,African-Islamic,-1.1777523287499776,-0.5200063950796097,
372,Ireland,English-Speaking,0.8905429564589291,-1.1231229843100017,
380,Italy,Catholic Europe,0.6282898153424533,0.2133559818705218,
392,Japan,Confucian,1.3300136024334095,1.695318758424994,
398,Kazakhstan,African-Islamic,-0.4242668318845144,-0.0909681871840789,
400,Jordan,African-Islamic,-1.2097938534182422,-1.274650390553162,
404,Kenya,African-Islamic,-0.1043982294446012,-0.7671033180239979,
410,South Korea,Confucian,0.0140062040304424,1.2833540325942636,
417,Kyrgyzstan,African-Islamic,-0.5075726121869187,-0.7762879755585229,
422,Lebanon,African-Islamic,-0.8047810459177467,-0.1320463912864208,
428,Latvia,Catholic Europe,-0.3478515809590755,1.0496514508526655,
434,Libya,African-Islamic,-0.9426876018261308,-1.4083295045454125,
440,Lithuania,Catholic Europe,-0.397595023224366,1.1834930408401438,
442,Luxembourg,Catholic Europe,1.7476923190192966,0.43812274890216,
446,Macau SAR,Confucian,0.5630227117871005,1.352332745215429,
458,Malaysia,West & South Asia,-0.3198217262858976,-0.3714467396988119,
462,Maldives,African-Islamic,-0.5057516197476042,-1.1563646110053754,
470,Malta,Latin America,-0.0583083697352676,-1.2790297500253405,
484,Mexico,Latin America,0.569046619011203,-1.3149264942047645,
496,Mongolia,Confucian,0.4230300550042207,0.9524975637672076,
498,Moldova,Orthodox Europe,-1.3535799136105533,0.7874378017891781,
499,Montenegro,Orthodox Europe,-0.3627340578115172,0.3469847666263452,
504,Morocco,African-Islamic,-0.9032100279162184,-0.3708266848542051,
528,Netherlands,Protestant Europe,2.322205430744606,0.5671657112157945,
554,New Zealand,English-Speaking,2.765105807574402,0.0573255265201077,
558,Nicaragua,Latin America,-0.2743695098185092,-1.5256317053211872,
566,Nigeria,African-Islamic,-0.7769338302145767,-1.0655441231881213,
578,Norway,Protestant Europe,2.261462785751872,0.7113023646366945,
586,Pakistan,African-Islamic,-0.48645128931379,-1.0687357349547963,
604,Peru,Latin America,-0.3193485138474041,-0.8283273707521632,
608,Philippines,Latin America,0.10472779606973,-1.2032720652947306,
616,Poland,Catholic Europe,-0.1357436495771291,-0.2894055205633007,
620,Portugal,Catholic Europe,-0.0928586091001266,-0.1160989985435933,
630,Puerto Rico,Latin America,0.7333970475802377,-1.448529169901075,
642,Romania,Orthodox Europe,-1.024159490375317,0.1102003620490555,
643,Russia,Orthodox Europe,-0.6165084339622918,0.8452027217429248,
646,Rwanda,African-Islamic,-0.7557017350868466,-0.9777085887740864,
688,Serbia,Orthodox Europe,-0.1596577249295579,0.5382082864837223,
702,Singapore,West & South Asia,0.105456852241584,0.1937886314797682,
703,Slovakia,Catholic Europe,0.1933021481799421,0.7761393676835896,
704,Vietnam,West & South Asia,0.4961913684926282,-0.4228966523980552,
705,Slovenia,Catholic Europe,0.9424324799427712,0.8420296310072347,
710,South Africa,African-Islamic,0.3068782010640267,-0.171038257642744,
716,Zimbabwe,African-Islamic,-1.161878305135928,-0.7040385171136747,
724,Spain,Catholic Europe,0.7072468251911928,0.1948512073518878,
752,Sweden,Protestant Europe,2.8480636597262663,1.0859570486460322,
756,Switzerland,Protestant Europe,2.1721990802230047,0.2205377852370606,
764,Thailand,West & South Asia,0.1428461696114337,-0.1613944416147825,
788,Tunisia,African-Islamic,-1.377126435289749,-0.4626917780777998,
792,Turkey,African-Islamic,-0.8293625850529269,-0.6742092382783361,
804,Ukraine,Orthodox Europe,-0.7888563267757666,0.7503413298320506,
807,North Macedonia,Orthodox Europe,0.2190743756238706,0.0054696105616244,
826,Great Britain,English-Speaking,1.9434688392950237,0.1748414916374717,
840,United States,English-Speaking,1.5641414453193323,-0.2928376506979711,
858,Uruguay,Latin America,1.2604695211846242,-0.2859509456807006,
862,Venezuela,Latin America,-0.1100429956102086,-0.8804570743408835,
887,Yemen,African-Islamic,-1.0865682256180789,-1.0908198218201637,
894,Zambia,African-Islamic,-0.7371567247088487,-0.2545908840882704,
909,North Ireland,English-Speaking,0.8394427649874777,-0.5343647186404973,
915,Kosovo,African-Islamic,-0.3170602345389858,-0.9789131699205684,
0,Anthropic claude-sonnet 4,AI system,2.3916416562690612,1.1319637932109379,Anthropic Claude 4
1,Anthropic claude-sonnet 4.5,AI system,1.6806871665203518,0.7863708455348473,Anthropic Claude 4.5
2,DeepSeek deepseek-chat ,AI system,1.403651079557991,1.2090808549143786,DeepSeek Chat
3,Gemini gemini-2.0 ,AI system,1.8816525617251834,1.3224080504009064,Google Gemini 2
4,Gemini gemini-2.5 ,AI system,1.647951971866928,0.9793015524796022,Google Gemini 2.5
5,Microsoft M365 Copilot ,AI system,3.9968142585831465,-0.7091783499523111,M365 Copilot
6,Mistral mistral-large ,AI system,1.6607054003562165,1.4901287403866328,Mistral Large
7,Mistral mistral-small ,AI system,1.7337193460575286,0.9005063874410508,Mistral Small
9,OpenAI gpt-3.5 ,AI system,3.544434685416905,0.19344902004338224,OpenAI GPT-3.5
11,OpenAI gpt-4 ,AI system,3.1922607164753183,-0.3346386449335969,OpenAI GPT-4
13,OpenAI gpt-4o ,AI system,0.8802051167060237,1.6399930571907553,OpenAI GPT-4o
14,OpenAI gpt-5 medium,AI system,1.3079895080127253,0.7765355651126117,OpenAI GPT-5 (med)
15,OpenAI gpt-5 mini,AI system,1.4846672239270162,1.0784993461797152,OpenAI GPT-5-mini
16,OpenAI gpt-5 minimal,AI system,3.714911446469235,0.48486441773638456,OpenAI GPT-5 (min)
17,OpenAI o4-mini ,AI system,1.6297233240023268,1.0250642360051614,OpenAI o4
18,Perplexity sonar ,AI system,2.2434665565754894,1.2040621442544865,Perplexity Sonar
19,XAI grok-3 ,AI system,1.2114757480910687,0.7699628260681205,XAI Grok 3
20,XAI grok-4 ,AI system,1.9047062271333626,0.4934321742069808,XAI Grok 4`;

// Removed
// Burkina Faso
// Cyprus
// Estonia
// Mali
// Northern Cyprus
// Trinidad and Tobago


// Column means & sds
const colMeans = [7.021085,0.1533646,3.799358,1.593051,1.544039,1.819518,1.877546,3.805097,2.068110,1.720547];
const colSds   = [3.252300,1.299132,2.985047,0.7500287,0.7364617,0.6221812,0.7059114,3.290408,0.8253914,0.4487313];
const weights  = [[-0.1116326, -0.2742291],[0.0890584, 0.2134507],[0.2313613, 0.1467377],[-0.1433251, 0.4358567],[-0.03312921, 0.2733023],[0.2504938, -0.1129848],[-0.3505356, 0.4623296],[0.31461040, 0.03355982],[-0.2970481, 0.05383156],[-0.2493942, 0.09156530]];

// QUESTIONS
const questions = [
  {
    code: 'F063',
    text: 'How important is God in your life? Please indicate your score using the scale, where 10 means very important and 1 means not at all important. Your score number:',
    type: 'scale', range: [1,10]
  },
  {
    code: 'Y003',
    text: 'In the following list of qualities that children can be encouraged to learn at home, which, if any, do you consider to be especially important? You can only respond with up to five qualities that you choose. Your five choices:',
    type: 'multi',
    options: [
      'Good manners','Independence','Hard work','Feeling of responsibility',
      'Imagination','Tolerance and respect for other people','Thrift, saving money and things',
      'Determination, perseverance','Religious faith','Not being selfish (unselfishness)','Obedience'
    ],
    max: 5
  },
  {
    code: 'F120',
    text: 'How justifiable do you think abortion is? Please indicate using the scale, where 10 means always justifiable and 1 means never justifiable.',
    type: 'scale',
    range: [1,10]
  },
  {
    code: 'G006',
    text: 'How proud are you to be your nationality?',
    type: 'choice',
    options: ['Very proud', 'Quite proud', 'Not very proud', 'Not at all proud']
  },
  {
    code: 'E018',
    text: "If greater respect for authority takes place in the near future, do you think it would be a good thing, a bad thing, or you don't mind?",
    type: 'choice',
    options: ['A good thing', 'A bad thing', "I don't mind"]
  },
  {
    code: 'Y002',
    text: 'People sometimes talk about what the aims of this country should be for the next ten years. Among the goals listed as follows, which two do you consider the most important?',
    type: 'multi',
    options: [
      'Maintaining order in the nation',
      'Giving people more say in important government decisions',
      'Fighting rising prices',
      'Protecting freedom of speech'
    ],
    max: 2
  },
  {
    code: 'A008',
    text: 'Taking all things together, rate how happy you would say you are.',
    type: 'choice',
    options: ['Very happy', 'Quite happy', 'Not very happy', 'Not at all happy']
  },
  {
    code: 'F118',
    text: 'How justifiable do you think homosexuality is? Please use the scale, where 1 means never justifiable, and 10 means always justifiable.',
    type: 'scale',
    range: [1,10]
  },
  {
    code: 'E025',
    text: 'Please tell me whether you have signed a petition, whether you might do it, or would never under any circumstances do it.',
    type: 'choice',
    options: ['Have signed one','Might do it','Would never do it']
  },
  {
    code: 'A165',
    text: 'Generally speaking, would you say that most people can be trusted or that you need to be very careful in dealing with people?',
    type: 'choice',
    options: ['Most can be trusted','Need to be very careful']
  }
];


// RESPONSES
let currentQ = 0;
let responses = {};

function renderQuestion() {
  const q = questions[currentQ];
  const container = document.getElementById('questionContent');
  container.innerHTML = `<h5>${q.code}</h5><p>${q.text}</p>`;
  const btnContainer = document.createElement('div');
  btnContainer.className = 'answer-buttons d-flex flex-wrap';

  if(q.type==='scale'){
    for(let i=q.range[0]; i<=q.range[1]; i++){
      let btn = document.createElement('button');
      btn.type='button';
      btn.className='btn btn-outline-primary';
      btn.textContent=i;
      if(responses[q.code]===i) btn.classList.add('active');
      btn.onclick=()=>{responses[q.code]=i; renderQuestion();};
      btnContainer.appendChild(btn);
    }
  }
  else if(q.type==='choice'){
    q.options.forEach(opt=>{
      let btn=document.createElement('button');
      btn.type='button';
      btn.className='btn btn-outline-primary';
      btn.textContent=opt;
      if(responses[q.code]===opt) btn.classList.add('active');
      btn.onclick=()=>{responses[q.code]=opt; renderQuestion();};
      btnContainer.appendChild(btn);
    });
  }
  else if(q.type==='multi'){
    let selected = responses[q.code] || [];
    q.options.forEach(opt=>{
      let btn=document.createElement('button');
      btn.type='button';
      btn.className='btn btn-outline-primary toggle-btn';
      btn.textContent=opt;
      if(selected.includes(opt)) btn.classList.add('active');
      btn.onclick=()=>{
        let idx = selected.indexOf(opt);
        if(idx>-1) selected.splice(idx,1);
        else if(selected.length < q.max) selected.push(opt);
        responses[q.code]=selected;
        renderQuestion();
      };
      btnContainer.appendChild(btn);
    });
  }
  container.appendChild(btnContainer);

  document.getElementById('prevBtn').disabled = currentQ===0;
  document.getElementById('nextBtn').textContent = currentQ===questions.length-1 ? 'Submit' : 'Next';
}

// SCORING
function compute_y002(answer) {
  const idxs = answer.map(v=>questions[5].options.indexOf(v)+1).sort((a,b)=>a-b);
  if (idxs[0]===1 && idxs[1]===3) return 1;
  if (idxs[0]===2 && idxs[1]===4) return 3;
  return 2;
}
function compute_y003(answer) {
  let ans = answer.map(a=>a.toLowerCase()).join(' ');
  let x = (ans.includes('independence')?1:0) +
          (ans.includes('determination')?1:0) -
          (ans.includes('faith')?1:0) -
          (ans.includes('obedience')?1:0);
  return Math.max(Math.min(x,2),-2);
}
function computeScore(code, ans){
  if(code==='F063'||code==='F120'||code==='F118') return Math.max(Math.min(ans,10),1);
  if(code==='G006') return ({'Very proud':1, 'Quite proud':2, 'Not very proud':3, 'Not at all proud':4}[ans]);
  if(code==='A008') return ({'Very happy':1, 'Quite happy':2, 'Not very happy':3, 'Not at all happy':4}[ans]);
  if(code==='E018') return ({'A good thing':1, "I don't mind":2, 'A bad thing':3}[ans]);
  if(code==='E025') return ({'Have signed one':1,'Might do it':2,'Would never do it':3}[ans]);
  if(code==='A165') return ({'Most can be trusted':1,'Need to be very careful':2}[ans]);
  if(code==='Y002') return compute_y002(ans);
  if(code==='Y003') return compute_y003(ans);
  return NaN;
}

// NEXT/BACK
document.getElementById('nextBtn').onclick=()=>{
  if(currentQ===questions.length-1){
    let scores = questions.map(q=>computeScore(q.code,responses[q.code]));
    let stdScores = scores.map((v,i)=>(v-colMeans[i])/colSds[i]);
    const PC1 = stdScores.reduce((sum, v, i) => sum + v * weights[i][0], 0);
    const PC2 = stdScores.reduce((sum, v, i) => sum + v * weights[i][1], 0);
    const x = 1.81*PC1 + 0.38;
    const y = 1.61*PC2 - 0.01;
    chart.data.datasets.push({label:'YOU',data:[{x,y,label:'YOU'}],pointBackgroundColor:'black',pointRadius:8});
    chart.data.datasets.push({
  label: 'YOU',
  data: [{ x, y, label: 'YOU' }],
  pointBackgroundColor: 'black',
  pointBorderWidth: 0,
  pointRadius: 8
});
    chart.update();
    bootstrap.Modal.getInstance(document.getElementById('questionsModal')).hide();
  } else {
    currentQ++;
    renderQuestion();
  }
};
document.getElementById('prevBtn').onclick=()=>{
  if(currentQ>0){ currentQ--; renderQuestion(); }
};

// DATA
function parseCSV(data){
  const [header,...lines]=data.trim().split("\n");
  const cols=header.split(",");
  return lines.map(line=>{
    const vals=line.split(",");
    return Object.fromEntries(cols.map((c,i)=>[c,isNaN(vals[i])?vals[i]:+vals[i]]));
  });
}
function regionColor(region) {
  const palette = {'African-Islamic':'#1f77b4','Confucian':'#ff7f0e','Catholic Europe':'#2ca02c','Latin America':'#c61718','Orthodox Europe':'#9467bd','English-Speaking':'#8c564b','Protestant Europe':'#e377c2','West & South Asia':'#7f7f7f','AI system':'#ff1423'};
  return palette[region] || '#000000';
}

// LABELS

// Move some labels arbitrarily to avoid collisions.
const labelOverrides = {
  // Right justify some
  'Georgia': { align: 'right', xoffset: 0, yoffset: -6 },
  'Tunisia': { align: 'right', xoffset: -6, yoffset: 4 },
  'Australia': { align: 'right', xoffset: -6, yoffset: 4 },
  'Italy': { align: 'right', xoffset: -6, yoffset: 4 },
  'Chile': { align: 'right', xoffset: -3, yoffset: 10 },
  'Indonesia': { align: 'right', xoffset: -6, yoffset: 2 },
  'grok-3': { align: 'right', xoffset: -6, yoffset: 4 },
  'Myanmar': { align: 'right', xoffset: -6, yoffset: 8 },
  'M365': { align: 'right', xoffset: -6, yoffset: 8 },
  'minimal': { align: 'right', xoffset: -6, yoffset: 8 },
  // Nudge some others
  'Portugal': { align: 'left', xoffset: -6, yoffset: -6 },
  'Thailand': { align: 'left', xoffset: 6, yoffset: 0 },
  'India': { align: 'left', xoffset: 6, yoffset: 8 },
  'China': { align: 'left', xoffset: 6, yoffset: 10 },
  'Germany': { align: 'left', xoffset: 6, yoffset:2 },
  'Sweden': { align: 'left', xoffset: 6, yoffset: 8 },
  'medium': { align: 'left', xoffset: 6, yoffset: 0 }
};

const labelPlugin = {
  id: 'pointLabels',
  afterDatasetsDraw(chart) {
    const { ctx } = chart;
    chart.data.datasets.forEach((dataset, datasetIndex) => {
      if (!chart.isDatasetVisible(datasetIndex)) return;
      const meta = chart.getDatasetMeta(datasetIndex);
      dataset.data.forEach((point, index) => {
        const { x, y } = meta.data[index].getProps(['x', 'y'], true);
        const label = point.label;
        const overrides = labelOverrides[label] || {};
        ctx.save();
        ctx.font = '10px sans-serif';
        ctx.fillStyle = dataset.pointBackgroundColor;
        ctx.textAlign = overrides.align || 'left';
        const xo = overrides.xoffset || 6;
        const yo = overrides.yoffset !== undefined ? overrides.yoffset : 4;
        ctx.fillText(label, x + xo, y + yo);
        ctx.restore();
      });
    });
  }
};

// CHART
let chart;

function initChart(points) {
  // Group countries by region
  const regionMap = {};
  points.forEach(p => {
    if (!regionMap[p.region]) regionMap[p.region] = [];
    regionMap[p.region].push({ x: p.x, y: p.y, label: p.country, remark: p.remark });
  });

  // Build datasets per region
  const datasets = Object.keys(regionMap).map(region => ({
    label: region,
    data: regionMap[region],
    pointBackgroundColor: regionColor(region),
    pointBorderWidth: 0,
    pointRadius: 5,
    hidden: region === "AI system"
  }));

  // MAke the actual chart
  chart = new Chart(document.getElementById('valuesChart'), {
    type: 'scatter',
    data: { datasets },
    options: {
      animation: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const point = ctx.raw;
              let out = point.label || "";
              if (point.remark) {
                out += " â€” " + point.remark;
              }
              out += ` (x: ${point.x.toFixed(2)}, y: ${point.y.toFixed(2)})`;
              return out;
            }
          }
        },
        legend: {
          display: false // or however you set up the legend buttons
        }
      },
      scales: {
        x: { title: { display: true, text: 'Survival vs Self-expression' } },
        y: { title: { display: true, text: 'Traditional vs Secular' } }
      }
    },
    plugins: [labelPlugin]
  });

  // Build Region buttons
  const toggles = document.getElementById('regionToggles');
  Object.keys(regionMap).forEach((region, idx) => {
    if (region === 'AI system') return; // skip the AI systems "region", see below
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-sm';
    btn.style.backgroundColor = regionColor(region);
    btn.style.color = 'white';
    btn.textContent = region;
    btn.dataset.regionIndex = idx;
    btn.classList.add('active'); // start visible

    btn.onclick = () => {
      const dsIndex = btn.dataset.regionIndex;
      const vis = chart.isDatasetVisible(dsIndex);
      chart.setDatasetVisibility(dsIndex, !vis);
      chart.update();
      btn.classList.toggle('active');
      btn.style.opacity = vis ? 0.4 : 1; // dim
    };
    toggles.appendChild(btn);
  });

  // AI System region is a bit different from the other "regions"
  const aiBtn = document.getElementById('aiSystemBtn');
  aiBtn.textContent = "Show AI systems";

  aiBtn.onclick = () => {
    const dsIndex = chart.data.datasets.findIndex(ds => ds.label === "AI system");
    if (dsIndex === -1) return;

    const visible = chart.isDatasetVisible(dsIndex);
    chart.setDatasetVisibility(dsIndex, !visible);
    chart.update();

    aiBtn.textContent = visible ? "Show AI systems" : "Hide AI systems";
  };
} // end of initChart

document.getElementById('startQuizBtn').addEventListener('click',()=>{
  currentQ=0;
  responses={};
  renderQuestion();
});

initChart(parseCSV(csvData));
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
